<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Inventario Laboratorio — Buscador</title>
<style>
  :root{--bg:#0b1020;--card:#0f1724;--muted:#9aa4b2;--accent:#7c3aed;--glass:rgba(255,255,255,0.03);}
  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,Arial;background:linear-gradient(180deg,var(--bg) 0%,#071021 100%);color:#e6eef8}
  .wrap{max-width:980px;margin:28px auto;padding:20px}
  .app{background:linear-gradient(180deg,var(--card),#07121b);border-radius:14px;padding:18px;box-shadow:0 8px 30px rgba(2,6,23,0.7)}
  header{display:flex;align-items:center;gap:16px}
  h1{margin:0;font-size:18px}
  .small{color:var(--muted);font-size:13px}
  .controls{display:flex;gap:10px;margin-top:14px;align-items:center}
  .seg{background:var(--glass);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);display:flex;gap:8px}
  input[type=text]{background:transparent;border:none;outline:none;color:inherit;font-size:15px;width:320px}
  select{background:transparent;border:none;color:inherit;padding:6px}
  button{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;color:inherit;cursor:pointer}
  .main{display:flex;gap:18px;margin-top:18px}
  .left{flex:1}
  .right{width:420px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  .big{font-size:20px;font-weight:700}
  .meta{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .pill{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:999px;font-size:13px}
  .sds-btn{display:inline-block;margin-top:12px;padding:10px 12px;border-radius:10px;background:linear-gradient(90deg,var(--accent),#4c1d95);color:white;border:none;cursor:pointer;text-decoration:none}
  .sds-empty{background:transparent;border:1px dashed rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:var(--muted);margin-top:10px}
  .nav{display:flex;gap:6px;align-items:center;margin-top:12px}
  .nav button{padding:6px 8px}
  .hint{color:var(--muted);font-size:13px;margin-top:10px}
  .footer{margin-top:14px;font-size:13px;color:var(--muted);text-align:right}
  @media(max-width:920px){.main{flex-direction:column}.right{width:100%}}
</style>
</head>
<body>
<div class="wrap">
  <div class="app">
    <header>
      <div>
        <h1>Inventario — Buscador (modo oscuro)</h1>
        <div class="small">Busca por nombre o CAS. El campo "pdf" es un enlace de descarga directo.</div>
      </div>
    </header>

    <div class="controls">
      <div class="seg">
        <select id="mode">
          <option value="nombre">Buscar por: Nombre</option>
          <option value="cas">Buscar por: CAS</option>
        </select>
        <input id="q" type="text" placeholder="Escribe para buscar..." />
        <button id="search">Buscar</button>
      </div>
      <div style="margin-left:auto" class="seg">
        <button id="exportCSV">Exportar CSV</button>
        <button id="reset">Reset</button>
      </div>
    </div>

    <div class="main">
      <div class="left">
        <div class="card" id="resultArea">
          <div class="small">Escribe un término y pulsa Buscar — aparecerá la tarjeta del reactivo aquí.</div>
        </div>

        <div class="hint">
          Los campos esperados en el CSV son:
          <code>nombre, compuestos, cantidad, presentacion, cas, proveedor, ubiacion, pdf, img</code>
        </div>
      </div>

      <div class="right">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="small">Detalles rápidos</div>
            <div class="small" id="count">Cargando datos…</div>
          </div>

          <div id="preview" style="margin-top:8px"></div>

          <div class="nav">
            <button id="prev">◀ Prev</button>
            <button id="next">Next ▶</button>
            <div style="flex:1"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      Datos cargados desde hoja de cálculo publicada como CSV — campos: nombre, compuestos, cantidad, presentacion, cas, proveedor, ubiacion, pdf, img.
    </div>
  </div>
</div>

<!-- Axios desde CDN -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
// === Array global que se llena desde el CSV ===
const DATA = [];

// === Helper para obtener elementos ===
const el = id => document.getElementById(id);

// === Utilidad para normalizar cadenas ===
function normalize(s){ return String(s||"").toLowerCase(); }

// === Render de la tarjeta principal ===
function renderCard(item){
  const hasPDF = item.pdf && String(item.pdf).trim() !== "";
  const hasImg = item.img && String(item.img).trim() !== "";

  const html = `
    <div class="big">${item.nombre || '—'}</div>
    <div class="small">CAS: <strong>${item.cas || '—'}</strong></div>

    <div class="meta">
      <div class="pill">Cantidad: ${item.cantidad || '—'}</div>
      <div class="pill">Presentación: ${item.presentacion || '—'}</div>
      <div class="pill">Proveedor: ${item.proveedor || '—'}</div>
      <div class="pill">Ubicación: ${item.ubiacion || '—'}</div>
    </div>

    <div style="margin-top:10px" class="small">
      Compuestos: ${item.compuestos || '—'}
    </div>

    <div style="margin-top:12px">
      ${
        hasPDF
          ? `<a class="sds-btn" href="${item.pdf}" target="_blank" rel="noopener noreferrer">
               Descargar / ver ficha (PDF)
             </a>`
          : `<div class="sds-empty">PDF no disponible. Completa la columna "pdf" en el CSV con un enlace directo.</div>`
      }
    </div>

    ${
      hasImg
        ? `<div style="margin-top:12px">
             <img src="${item.img}" alt="Imagen" style="max-width:100%;border-radius:8px;"/>
           </div>`
        : '<div class="sds-empty">Imágen no disponible. Completa la columna "img" en el CSV con un enlace directo.</div>'
    }
  `;
  el('resultArea').innerHTML = html;

  el('preview').innerHTML = `
    <div class="small">
      <strong>${item.nombre || '—'}</strong><br>
      CAS: ${item.cas || '—'}<br>
      Ubicación: ${item.ubiacion || '—'}
    </div>
  `;
}

// === Búsqueda y navegación ===
let results = [];
let idx = 0;

function doSearch(){
  const mode = el('mode').value; // 'nombre' o 'cas'
  const q = normalize(el('q').value);

  if(!q){
    el('count').textContent = DATA.length + ' cargados';
    el('resultArea').innerHTML = '<div class="small">Introduce término de búsqueda.</div>';
    return;
  }

  results = DATA.filter(d => {
    if(mode === 'nombre') return normalize(d.nombre).includes(q);
    if(mode === 'cas') return normalize(d.cas).includes(q);
    return false;
  });

  el('count').textContent = results.length + ' encontrados';
  idx = 0;

  if(results.length > 0){
    renderCard(results[idx]);
  }else{
    el('resultArea').innerHTML = '<div class="small">No se encontraron coincidencias.</div>';
    el('preview').innerHTML = '';
  }
}

// Eventos de búsqueda / navegación
el('search').addEventListener('click', doSearch);
el('q').addEventListener('keydown', (e)=>{ if(e.key === 'Enter') doSearch(); });
el('next').addEventListener('click', ()=>{
  if(results.length===0) return;
  idx = (idx+1) % results.length;
  renderCard(results[idx]);
});
el('prev').addEventListener('click', ()=>{
  if(results.length===0) return;
  idx = (idx-1+results.length)%results.length;
  renderCard(results[idx]);
});

// === Exportar CSV desde DATA ===
el('exportCSV').addEventListener('click', ()=>{
  if(!DATA || DATA.length===0) return;

  const cols = [
    'nombre','compuestos','cantidad','presentacion',
    'cas','proveedor','ubiacion','pdf','img'
  ];

  const rows = [cols.join(",")].concat(
    DATA.map(r =>
      cols.map(c =>
        '"' + String(r[c] === null || r[c] === undefined ? '' : r[c]).replace(/"/g,'""') + '"'
      ).join(",")
    )
  );

  const csv = rows.join("\n");
  const blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = "inventario_export.csv";
  a.click();
  URL.revokeObjectURL(url);
});

// === Reset de vista (no borra DATA, solo limpia la UI) ===
el('reset').addEventListener('click', ()=>{
  results = [];
  idx = 0;
  el('resultArea').innerHTML = '<div class="small">Vista reseteada. Los datos siguen cargados.</div>';
  el('preview').innerHTML = '';
  el('count').textContent = DATA.length + ' cargados';
});

// ==================================================
//  DESCARGA Y PARSEO DEL CSV PUBLICADO EN GOOGLE SHEETS CON AXIOS
// ==================================================

// URL publicada (output=csv). Ajusta gid si hace falta.
//const PUBLISHED_URL =
  //'https://docs.google.com/spreadsheets/d/e/2PACX-1vQN07IM5nKuDQ_9N5WjPzSmNcIGyxcBGpz2j25t5OC3YZyUEHBhS-kJJic4OiLIGRrjjjB_NS91QaZ3/pub?gid=0&output=csv';


const PUBLISHED_URL =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRWg1qJfPxKgzkR7au7W0HYZJdQyyRPPNpe91a2m2rN5u3H9cmhQ0iuD2Wv4Oje4Y2lzvbOJs6erYFp/pub?output=csv';

// Parseo simple de CSV (sin manejo avanzado de comillas)
function parseCSV(text){
  const lines = text.trim().split(/\r?\n/);
  
  if(lines.length <= 1) return [];

  const headers = lines[0].split(',').map(h => h.trim());
  const rows = [];

  for(let i = 1; i < lines.length; i++){
    let line = lines[i];
    if(!line.trim()) continue;

    line = line.replaceAll('"','')
    
    console.log(line)

    const cols = line.split(',');
    const rowObj = {};
    headers.forEach((h, idx) => {
      rowObj[h] = (cols[idx] || '').replaceAll(";",',').trim();
    });
    rows.push(rowObj);
  }
  return rows;
}

// Versión con Axios
async function fetchPublishedSheetDataAxios(publishedUrl){
  try{
    const response = await axios.get(publishedUrl, {
      responseType: 'text',
      headers: {
        'Accept': 'text/csv'
      },
      // En navegador, CORS lo controla el servidor; aquí solo pedimos texto
      withCredentials: false
    });

    return response.data; // texto CSV
  }catch(error){
    console.error('Error al obtener datos publicados:', error);
    return null;
  }
}

// Inicializar: descargar CSV y llenar DATA
(async () => {
  el('count').textContent = 'Cargando datos…';

  const textData = await fetchPublishedSheetDataAxios(PUBLISHED_URL);

  if(textData){
    const rows = parseCSV(textData);

    const mapped = rows.map(r => ({
      // Se respetan exactamente estos nombres
      nombre:       r.nombre       || r.Nombre      || '',
      compuestos:   r.compuestos   || '',
      cantidad:     r.cantidad     || '',
      presentacion: r.presentacion || '',
      cas:          r.cas          || r.CAS         || '',
      proveedor:    r.proveedor    || '',
      // El nombre de columna es "ubiacion" (sin c) según tu definición
      ubiacion:     r.ubiacion     || r.ubicacion   || '',
      pdf:          r.pdf          || '',
      img:          r.img          || ''
    }));

    DATA.push(...mapped);
    el('count').textContent = 'Lista cargada: ' + DATA.length;

    // Muestra el primero como vista inicial (opcional)
    if(DATA.length > 0){
      results = DATA.slice();
      idx = 0;
      renderCard(DATA[0]);
    }
  }else{
    el('count').textContent = 'Error al cargar datos';
  }
})();
</script>
</body>
</html>
